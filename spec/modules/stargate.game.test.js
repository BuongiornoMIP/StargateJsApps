/**
 * Created by pasquale on 01/02/16.
 */
function isRunningOnIos(){
    return window.device.platform.toLowerCase() == "ios";
}

function isRunningOnAndroid(){
    return window.device.platform.toLowerCase() == "android";
}
var gameObject = {
    id: "94904060fe5d50dd6c22b927c6a7c71d",
    publisher: {
    title_publisher: "anuman",
        url_publisher: "#!/publisher/anuman"
    },
    title: "Prohibition 1930",
    description: "Take on the role of William Hall, a tenacious and incorruptible detective who is determined to avenge his family's assassination! Embark upon a terrible vendetta and wipe out every member of the mob covering up Vincent Parrizi's escape. Make your way through vast environments to the rhythm of frenetic shootouts, and slow down time to rack up headshots! Will you try to gather clues in order to arrest the godfather or will you kill him in revenge?",
    description_short: "Take on the role of William Hall, a tenacious and incorruptible detective who is determined to av...",
    images: {
    screenshot: [
        "http://s2.motime.com/p/bcontents/absimageappscreenshot1_5/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/51/51a21222-f6be-40b3-8267-fd3228ab0275/prohibition-1930.bin?v=1450266963",
        "http://s2.motime.com/p/bcontents/absimageappscreenshot1_5/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/52/86e1c95a-cbba-4875-b528-0ecf029bf96d/prohibition-1930.bin?v=1450266963",
        "http://s2.motime.com/p/bcontents/absimageappscreenshot1_5/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/49/2d642371-2960-435f-ac7c-b4e4923d81a1/prohibition-1930.bin?v=1450266963"
    ],
    cover: {
        ratio_1_4:"http://s2.motime.com/p/bcontents/absimageapp1_4/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/50/42624bdc-c47f-437d-bcbb-e1a7b3d48d3f/prohibition-1930.bin?v=1450266963",
            ratio_0_7:"http://s2.motime.com/p/bcontents/absimageapp0_7/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/51/148348cd-05e3-4378-bae8-b7648ffa9f1f/prohibition-1930.bin?v=1450266963",
            ratio_1: "http://s2.motime.com/p/bcontents/absimageapp1/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/51/d2179a25-f07d-422c-adbc-7cb1bb001b62/prohibition-1930.bin?v=1450266963",
            ratio_2: "http://s2.motime.com/p/bcontents/absimageapp2/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/50/080d3dce-c136-4584-8c6f-85bc8ade1539/prohibition-1930.bin?v=1450266963",
            ratio_1_5:"http://s2.motime.com/p/bcontents/absimageapp1_5/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/52/1651accd-dc66-4177-b57c-3f65765068b2/prohibition-1930.bin?v=1450266963"
    },
    icon: "http://s2.motime.com/p/bcontents/absimageappicon/h[HSIZE]/w[WSIZE]/xx_gameasy/mnt/alfresco_content_prod/contentstore/2014/2/25/10/52/44293609-5caa-4106-b0c9-a43da15b48e1/prohibition-1930.bin?v=1450266963"
    },
    category: {
        id_category: "5bfa4fcff1f05613b419ebb072035925",
            name_category: "Adventure",
            cs_id: "60e9cc48-2662-4ad7-9e1d-dc27b9e5b3d3",
            born_date_category: "Thu, 26 Nov 2015 08:17:47 -0000",
            inserted_date_category: "Fri, 11 Dec 2015 14:17:05 -0000",
            source_id: "alfresco_xx_gameasy_Adventure",
            supplier_id: "alfresco",
            url_category: "#!/category/5bfa4fcff1f05613b419ebb072035925/Adventure",
            url_leaf_engine_subscription_category: "",
            url_preview_big_category: "",
            url_preview_small_category: ""
    },
    url_zoom: "#!/games/prohibition-1930_94904060fe5d50dd6c22b927c6a7c71d",
    url_zoom_simple: "prohibition-1930_94904060fe5d50dd6c22b927c6a7c71d",
    img_qrcode: "http://www2.gameasy.com/qrcode?text=http%3A%2F%2Fwww2.gameasy.com%2Fsetwelcome%3Freturn_url%3Dhttp%253A%252F%252Fwww2.gameasy.com%252F%2523%2521%252Fgames%252Fprohibition-1930_AA990001747",
    url_share: "http://www2.gameasy.com/share/games/prohibition-1930_AA990001747",
    url_leaf_engine_subscription: "http://www2.gameasy.com/subscribe/content/AA990001747",
    url_api_dld: "http://www2.giochissimo.it/pask/zip/FruitSlicer.zip",
    alfresco_id: "AA990001747",
    counters_matches: "",
    counters_favourites: "",
    cs_id: "AA990001747",
    url_play: "http://www2.gameasy.com/html5gameplay/94904060fe5d50dd6c22b927c6a7c71d/game/prohibition-1930",
    has_sdk: "",
    format: "html5applications",
    access_type: {
        guest: false,
        free: false,
        premium: true
    }
};

// URL API DLD RESPONSE
// url_api_dld:http://www2.gameasy.com/ww//v01/contents/<game-id>/download?formats=html5applications
/*{
    "status": 200,
    "url_binary":"http://"
    "url_download": "http://www2.gameasy.com/ww/html5gameplay/dc/e0/dce0fe873d4cd836f63af5c8ba77bb8d/xx_gameasy/game/black_gold_plumber/black_gold_plumber_index.html",
    "message": "WEBAPP_CONTENT_DOWNLOAD_STARTED",
    "md5":"1232qwf23t",
    "size":5678
}*/
/*
{
    "status":1403,
    "message":null
}*/

function createFolder(where, name){
    return new Promise(function(resolve,reject){
        window.resolveLocalFileSystemURL(where,
            function(dirEntry){
                dirEntry.getDirectory(name, {create:true},
                    function(entry){
                        resolve(entry);
                    }, function(err){
                        reject(err);
                    }
                );
            },
            function(err){
                reject(err);
            });
    });
}

function mock_file_download_success(url, filepath, saveAsName, _onProgress){
    console.log("DOWNLOAD MOCK", url, filepath, saveAsName, _onProgress);
    var transformedObj = {
        path:filepath + saveAsName,
        internalURL:"cdv:xxx",
        isFile:true,
        isDirectory:false
    };
    return Promise.resolve(new Array(transformedObj));
}

function promResolvedWith(obj){
    return function(){
        return Promise.resolve(obj);
    }
}

function promRejectWith(obj){
    return Promise.reject(obj);
}

function fileExists(url){
    return new Promise(function(resolve){
        window.resolveLocalFileSystemURL(url, function(entry){

            resolve(entry.isFile);

        }, function(fileError){
            resolve(fileError.code !== 1);
        });
    });
}

function readDir(url){
    return new Promise(function(resolve, reject){
        window.resolveLocalFileSystemURL(url, function(dirEntry){
                var reader = dirEntry.createReader();
                reader.readEntries(function(entries){
                    resolve(entries);
                }, reject);
        }, reject);
    });
}
var GamifiveInfo = {"label":"it_igames",
    "contentId":"4de756a55ac71f45c5b7b4211b71219e",
    "userId":"aac3121ebf5111e5a728005056b60712",
    "fbUserId":null,
    "fbAppId":"497938953670292",
    "fbConnected":false,
    "requireFbConnect":true,
    "fbExternal":false,
    "userFreemium":false,
    "challenge":{"id":null},
    "game":{"title":"Fruit Slicer"},
    "dictionary": {
        "messageOfFbChallenge":"Il mio punteggio \u00e8 %s, prova a battermi!",
        "matchLeftSingular":"hai ancora solo <span>%s<\/span> partita",
        "matchLeftPlural":"hai ancora <span>%s<\/span> partite per allenarti!",
        "matchLeftNone":"Non hai pi\u00f9 crediti! :("
    },
    "user":
    {"userId":"aac3121ebf5111e5a728005056b60712",
        "fbUserId":null,
        "fbConnected":false,
        "userFreemium":false,
        "nickname":"william_40e33",
        "avatar":{
            "src":"http:\/\/s2.motime.com\/img\/wl\/webstore_html5game\/images\/avatar\/big\/avatar_05.png?v=20150610133322",
            "name":"avatar_05.png"}
    }
};

describe("Game module tests", function() {
    function removeFolders(names, done){
        var counter = 0;
        for(var i = 0; i < names.length;i++){
            window.resolveLocalFileSystemURL(STORAGE_DIR + names[i], function(entry){
                entry.removeRecursively(function(result){
                    counter += 1;

                    if(counter == names.length){
                        done();
                    }
                },function(){
                    done();
                });

            }, function(){
                done();
            });
        }
    }
    var game = stargateModules.game._public;
    game.initialize = stargateModules.game._protected.initialize;
    console.log(game);
    var TEST_FOLDER_DIR,
        STORAGE_DIR,
        GAMES_DIR,
        SDK_DIR,
        TEST_FOLDER_NAME = "Test";

    beforeAll(function(done){
        document.addEventListener("deviceready", function(readyEvent){
            STORAGE_DIR = cordova.file.applicationStorageDirectory;
            if(isRunningOnIos()){ STORAGE_DIR += "Documents/"; }
            GAMES_DIR = STORAGE_DIR + "gfsdk/";
            SDK_DIR = STORAGE_DIR + "games/";
            done();
        });
    });

    beforeEach(function(done) {
        done();
    });

    afterEach(function(done){
        removeFolders(["gfsdk", "games"], done);
    });

    it("Game should exists", function(done) {
        expect(game).toBeDefined();
        done();
    });

    it("Game folders should exists after initialize", function(done) {
        game.initialize(GamifiveInfo.user)
            .then(function(results){
                console.log("game init results:", results);
                var secondResult = results[1][0];
                var firstResult = results[0][0];
                expect(firstResult.path).toEqual(GAMES_DIR);
                expect(secondResult.path).toEqual(SDK_DIR + "gfsdk.min.js");
                expect(secondResult.isFile).toEqual(true);
                done();
            })
            .catch(function(err){
                console.error("game init err", err);
                done();
            });
    });

    it("SDK should not be downloaded if already there", function(done) {
        var SDK_URL = "http://s.motime.com/js/wl/webstore_html5game/gfsdk/dist/gfsdk.min.js";
        //var originalDownload = stargateProtected.file.download;
        //var originalFileExists = stargateProtected.file.fileExists;
        //var originalDirExists = stargateProtected.file.dirExists;

        //MOCK DOWNLOAD
        //stargateProtected.file.download = mock_file_download_success;

        //spyOn(stargateProtected.file, "download");

        var firstInit = game.initialize(GamifiveInfo.user)
            .then(function(results){
                console.log(results);
                expect(results[0][0].path).toEqual(GAMES_DIR);
                expect(results[1][0].path).toEqual(SDK_DIR + "gfsdk.min.js");
            }).then(function(){

                //MOCK FILE EXISTS AND DIREXISTS
                //stargateProtected.fileExists = promResolvedWith(true);
                //stargateProtected.dirExists = promResolvedWith(true);
                return game.initialize(GamifiveInfo.user);
            })
            .then(function(results){
                expect(results).toBeDefined();

                //if returns true the file/dirs already exists
                expect(results[0]).toBe(true);
                expect(results[1]).toBe(true);

                //restore original reference
                //stargateProtected.file.download = originalDownload;
                //stargateProtected.fileExists = originalFileExists;
                //stargateProtected.dirExists = originalDirExists;
                done();
            })
            .catch(function(err){
                console.error("game init err", err);
                //stargateProtected.file.download = originalDownload;
                //stargateProtected.fileExists = originalFileExists;
                //stargateProtected.dirExists = originalDirExists;
                done();
            });
    });

    it("Test simple game download(save meta.json)", function(done){
        function log(){
            console.log(arguments);
        }
        var cbks = {
            onEnd:function(e){console.log("END", e);
                if(e.type == "download"){
                    console.log(e);
                }
            },
            onStart:function(e){
                console.log("START", e);
            }
        };

        game.initialize(GamifiveInfo.user)
            .then(function(){
                return game.download(gameObject, cbks);
            })
            .then(function(results){
                expect(results).toBeDefined(results);
                done();
            })
            .catch(function(err){
                expect(true).toBe(false);
                console.error(err);
                done();
            });

    });

    it("Test abortDownload", function(done){

        game.initialize(GamifiveInfo.user)
            .then(function(){
                game.download(gameObject);

                setTimeout(function pippo(){
                    var res = game.abortDownload();
                    expect(res).toBe(true);
                    done();
                }, 10);
            });
    });

    it("Test abortDownload should not to abort if is not downloading", function(done){

        game.initialize(GamifiveInfo.user);

                setTimeout(function pippo(){
                    var res = game.abortDownload();
                    expect(res).toBe(false);
                    done();
                }, 500);
    });

    it("Test download game already exists", function(done){

        game.initialize(GamifiveInfo.user)
            .then(function(results){
               console.log(results);
               return createFolder(GAMES_DIR, gameObject.id);
            })
            .then(function(result){
                return game.download(gameObject);
            })
            .catch(function(reason){
                expect(reason).toEqual({12:"AlreadyExists",gameID:gameObject.id});
                done();
            });
    });

    it("Should download the game, and modify the index.html with local sdk",function(done){
        game.initialize()
            .then(function(){
                return game.download(gameObject, {onEnd:function(e){console.log("DONE",e.type);}});
            })
            .then(function(result){
                expect(result).toBeDefined();
                var gamePath = GAMES_DIR + gameObject.id;
                done();
            }).catch(function(reason){
                console.error(reason);
            });
    });
});
