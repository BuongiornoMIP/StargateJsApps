/*!
 * StargateJS Apps
 * v0.2.7
 * Copyright 2015 DMobileLab. http://buongiorno.com/
 * See LICENSE in this repository for license information
 */
!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof module&&module.exports?module.exports=n():e.Stargate=n()}(this,function(){function e(e){l.type=e.type,l.networkState=navigator.connection.type}function n(){l.networkState=navigator.connection.type,"none"===navigator.connection.type?l.type="offline":l.type="online"}function t(){return window.cordova.file?a.file.readFileAsJSON(window.cordova.file.applicationDirectory+"www/manifest.json"):window.hostedwebapp?new Promise(function(e,n){window.hostedwebapp.getManifest(function(n){e(n)},function(e){p(e),n(new Error(e))})}):Promise.reject(new Error("getManifest() no available reading mechanism!"))}function r(){this.initialize=function(e,n,t){p("unimplemented"),t("unimplemented")},this.createBanner=function(e,n,t){p("unimplemented"),t("unimplemented")},this.hideBanner=function(e,n,t){p("unimplemented"),t("unimplemented")},this.removeBanner=function(e,n,t){p("unimplemented"),t("unimplemented")},this.showBannerAtSelectedPosition=function(e,n,t){p("unimplemented"),t("unimplemented")},this.showBannerAtGivenXY=function(e,n,t){p("unimplemented"),t("unimplemented")},this.registerAdEvents=function(e,n,t){p("unimplemented"),t("unimplemented")},this.prepareInterstitial=function(e,n,t){p("unimplemented"),t("unimplemented")},this.showInterstitial=function(e,n,t){p("unimplemented"),t("unimplemented")}}var i="0.2.7",o={},a={};!function(e){function n(e,t){this.level=n.levels[e.toUpperCase()],this.tag=t}function t(e){var n=0;return{next:function(t){return t&&(n=0),n<e.length?{value:e[n++],done:!1}:{done:!0}}}}function r(e,n){e+="?";var t="";for(var r in n)t+=encodeURIComponent(r)+"="+encodeURIComponent(n[r])+"&";return t.length>0&&(t=t.substring(0,t.length-1)),e+t}n.levels={ALL:5,ERROR:4,WARN:3,INFO:2,DEBUG:1,OFF:0},n.prototype.e=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.ERROR&&window.console.error.apply(console,e)},n.prototype.i=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.WARN&&window.console.info.apply(console,e)},n.prototype.w=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.INFO&&window.console.warn.apply(console,e)},n.prototype.d=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.DEBUG&&window.console.log.apply(console,e)},n.prototype.setLevel=function(e){this.level=n.levels[e]};var i={Iterator:t,Logger:n,composeApiString:r};e?e.Utils=i:window.Utils=i}(a),function(e,n){function t(e){var n=e.map(function(e){return{fullPath:e.fullPath,path:e.toURL(),internalURL:e.toInternalURL(),isFile:e.isFile,isDirectory:e.isDirectory}});return 1==n.length?n[0]:n}var r,i={};return i.LOG=r=new n("ALL","[File - module]"),i.ERROR_MAP={1:"NOT_FOUND_ERR",2:"SECURITY_ERR",3:"ABORT_ERR",4:"NOT_READABLE_ERR",5:"ENCODING_ERR",6:"NO_MODIFICATION_ALLOWED_ERR",7:"INVALID_STATE_ERR",8:"SYNTAX_ERR",9:"INVALID_MODIFICATION_ERR",10:"QUOTA_EXCEEDED_ERR",11:"TYPE_MISMATCH_ERR",12:"PATH_EXISTS_ERR"},i.currentFileTransfer=null,i.resolveFS=function(e){return new Promise(function(n,t){window.resolveLocalFileSystemURL(e,n,t)})},i.appendToFile=function(e,n,r){return r=void 0===arguments[2]?!1:arguments[2],i.resolveFS(e).then(function(e){return new Promise(function(i,o){e.createWriter(function(a){r||a.seek(a.length);var s=new Blob([n],{type:"text/plain"});a.write(s),a.onerror=o,a.onabort=o,a.onwriteend=function(){i(t([e]))}},o)})})},i.readFileAsHTML=function(e){return i.readFile(e).then(function(e){return(new window.DOMParser).parseFromString(e,"text/html")})},i.readFileAsJSON=function(e){return i.readFile(e).then(function(e){try{return Promise.resolve(window.JSON.parse(e))}catch(n){return Promise.reject(n)}})},i.removeFile=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.remove(function(e){n(null===e||"OK"===e)},t)})})},i.removeDir=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.removeRecursively(function(e){n(null===e||"OK"===e)},t)})})},i._promiseZip=function(e,n,t){return r.d("PROMISEZIP:",arguments),new Promise(function(r,i){window.zip.unzip(e,n,function(e){0===e?r(!0):i(e)},t)})},i.download=function(e,n,r,o){var a=new window.FileTransfer;return a.onprogress=o,i.currentFileTransfer=a,new Promise(function(o,s){a.download(window.encodeURI(e),n+r,function(e){o(t([e])),i.currentFileTransfer=null},function(e){s(e),i.currentFileTransfer=null},!0)})},i.createDir=function(e,n){return i.resolveFS(e).then(function(e){return new Promise(function(r,i){e.getDirectory(n,{create:!0},function(e){r(t([e]))},i)})})},i.fileExists=function(e){return new Promise(function(n){window.resolveLocalFileSystemURL(e,function(e){n(e.isFile)},function(e){n(1!==e.code)})})},i.dirExists=function(e){return new Promise(function(n){window.resolveLocalFileSystemURL(e,function(e){n(e.isDirectory)},function(e){n(1!=e.code)})})},i.requestFileSystem=function(e,n){return new Promise(function(t,r){window.requestFileSystem(e,n,t,r)})},i.readDir=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,r){var i=e.createReader();i.readEntries(function(e){n(t(e))},r)})})},i.readFile=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.file(function(e){var r=new FileReader;r.onerror=t,r.onabort=t,r.onloadend=function(){var e=this.result;n(e)},r.readAsText(e)})})})},i.createFile=function(e,n){return i.resolveFS(e).then(function(e){return new Promise(function(r,i){e.getFile(n,{create:!0},function(e){r(t([e]))},i)})})},i.write=function(e,n){return i.appendToFile(e,n,!0)},i.moveDir=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return r.d("moveDir:",o,t),Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(e){return r.d("moveDir: resolved entries",e),new Promise(function(n,r){e[0].moveTo(e[1],t,n,r)})})},i.copyFile=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(e){return r.d("copyFileTo",e),new Promise(function(n,r){e[0].copyTo(e[1],t,n,r)})})},i.copyDir=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(i){return r.d("copyDir",e,"in",n),new Promise(function(e,n){i[0].copyTo(i[1],t,e,n)})})},e.file=i,i}(a,a.Utils.Logger),function(e,n,t,r,i){"use strict";function o(){}function a(n){function r(){var n=e.createDir(v.BASE_DIR,"games"),t=e.createDir(v.BASE_DIR,"scripts");return Promise.all([n,t]).then(function(n){return I.d("GamesDir and ScriptsDir created",n),I.d("Getting SDK from:",y),Promise.all([e.download(y,n[1].path,"gfsdk.min.js"),e.download(_,n[1].path,"dixie.js"),e.copyDir(v.WWW_DIR+"gameover_template",v.BASE_DIR+"gameover_template"),e.copyDir(v.WWW_DIR+"plugins",v.SDK_DIR+"plugins"),e.copyFile(v.CORDOVAJS,v.SDK_DIR+"cordova.js"),e.copyFile(v.CORDOVA_PLUGINS_JS,v.SDK_DIR+"cordova_plugins.js"),e.copyFile(v.STARGATEJS,v.SDK_DIR+"stargate.js"),e.copyFile(v.WWW_DIR+"js/gamesFixes.js",v.SDK_DIR+"gamesFixes.js")])})}if(I.d("Initialized called with:",n),!e)return Promise.reject("Missing file module!");if(n&&n.bundleGames){for(var o=0;o<n.bundleGames.length;o++)D.content_id=n.bundleGames[o],R.push(t(S,D));I.d("addressesForMeta composed but not called:",R)}try{f=window.cordova.file.applicationStorageDirectory,p=window.cordova.file.cacheDirectory,m=window.cordova.file.tempDirectory,g=window.cordova.file.applicationDirectory+"www/",h=window.cordova.file.applicationDirectory+"www/js/stargate.js",w=window.cordova.file.dataDirectory}catch(a){return I.e(a),Promise.reject(a)}I.i("cordova JS dir to include",v.CORDOVAJS),"ios"==window.device.platform.toLowerCase()&&(f+="Documents/"),"android"==window.device.platform.toLowerCase()&&(m=p),v.SDK_DIR=f+"scripts/",v.SDK_RELATIVE_DIR="../../scripts/",v.GAMEOVER_RELATIVE_DIR="../../gameover_template/",v.GAMES_DIR=f+"games/",v.BASE_DIR=f,v.CACHE_DIR=p,v.TEMP_DIR=m,v.CORDOVAJS=g+"cordova.js",v.CORDOVA_PLUGINS_JS=g+"cordova_plugins.js",v.STARGATEJS=g+"js/stargate.js",v.DATA_DIR=w,v.GAMEOVER_DIR=v.BASE_DIR+"gameover_template/",v.WWW_DIR=g,i.game._public.GAMES_DIR=v.GAMES_DIR;var s=e.dirExists(v.GAMES_DIR),c=e.fileExists(v.SDK_DIR+"gfsdk.min.js");return Promise.all([s,c]).then(function(e){return e[0]||e[1]?Promise.resolve(!0):r()})}function s(n){return I.d("_getIndexHtmlById",v.GAMES_DIR+n),e.readDir(v.GAMES_DIR+n).then(function(e){return I.d("_getIndexHtmlById readDir",e),e.filter(function(e){var n=new RegExp(/index\.html$/i);return n.test(e.path)})})}function c(e){I.d("_removeRemoteSDK");for(var n,t=e.querySelectorAll("script"),r=0;r<t.length;r++)if(-1!==t[r].src.indexOf("gfsdk")){n=t[r],I.d("_removeRemoteSDK",n),n.parentNode.removeChild(n);break}return e}function l(e,n){e=c(e);var t,r=Array.isArray(n)===!1?[n]:n;I.d("injectScripts",r);var i=document.createElement("meta");i.httpEquiv="Content-Security-Policy",i.content="default-src * data: content: cdvfile: file: http: https: gap: https://ssl.gstatic.com 'unsafe-inline' 'unsafe-eval';style-src * cdvfile: http: https: 'unsafe-inline';",e.head.appendChild(i);for(var o=0;o<r.length;o++)if(r[o].endsWith(".css")){I.d("css inject:",r[o]);var a=e.createElement("link");a.rel="stylesheet",a.href=r[o],e.head.appendChild(a)}else t=document.createElement("script"),t.src=r[o],e.head.appendChild(t);return I.d("Cleaned dom:",e),e}function u(n,t){var r;return s(n).then(function(n){return r=n[0].path,e.readFileAsHTML(n[0].path)}).then(function(e){return I.d("_injectScripts"),I.d(e),l(e,t)}).then(function(e){I.d("Serialize dom");var n=(new XMLSerializer).serializeToString(e),t='<html xmlns="http://www.w3.org/1999/xhtml"';return n=n.replace(t,"<html")}).then(function(n){return I.d("Write dom:",r,n),e.write(r,n)})}function d(e){var n=new RegExp(/index\.html$/i);return n.test(e)}var f,p,m,g,w,h,v={},y="http://s2.motime.com/js/wl/webstore_html5game/gfsdk/dist/gfsdk.js?timestamp="+Date.now(),_="http://s2.motime.com/tbr/dixie.js?country=it-igames&timestamp="+Date.now(),S="http://resources2.buongiorno.com/lapis/apps/contents.getList",R=[],D={content_id:"",formats:"html5applications",sort:"-born_date",category:"b940b384ff0565b06dde433e05dc3c93",publisher:"",size:6,offset:0,label:"",label_slug:"",access_type:"",real_customer_id:"xx_gameasy",lang:"en",use_cs_id:"",white_label:"xx_gameasy",main_domain:"http://www2.gameasy.com/ww/&country=it",fw:"gameasy",vh:"ww.gameasy.com",check_compatibility_header:0},I=new n("ALL","[Game - module]");o.prototype.download=function(n,t){function r(e){return function(n){var t=Math.round(n.loaded/n.total*100);a({percentage:t,type:e})}}function i(){return s({type:"download"}),I.d("Download:",n.id,n.response_api_dld.binary_url),e.download(n.response_api_dld.binary_url,v.TEMP_DIR,l+".zip",r("download")).then(function(t){return s({type:"unzip"}),I.d("unzip:",n.id,v.TEMP_DIR+l),e._promiseZip(t.path,v.TEMP_DIR+l,r("unzip"))}).then(function(t){I.d("Unzip ended",t),c({type:"unzip"});var r=n.response_api_dld.url_download,i=r.substring(r.lastIndexOf("game"),r.length).split("/"),o="";return I.d("Get the right index folder of the game",i),i.length>2&&d(i[i.length-1])?(o=v.TEMP_DIR+[l,i[i.length-2]].join("/"),I.d("More than one level folders before index.html",i,o)):(o=v.TEMP_DIR+l,I.d("One level folder before index.html",i,o)),I.d("Copy game folder in games/",o,v.GAMES_DIR+l),e.moveDir(o,v.GAMES_DIR+l)}).then(function(n){return I.d("Remove zip from:",v.TEMP_DIR+l+".zip","last operation result",n),e.removeFile(v.TEMP_DIR+l+".zip")}).then(function(){return I.d("Save meta.json for:",n.id),e.createFile(v.GAMES_DIR+l,"meta.json").then(function(t){return e.write(t.path,JSON.stringify(n))})}).then(function(e){return I.d("result last operation:save meta.json",e),I.d("InjectScripts in game:",n.id,g),u(n.id,[v.SDK_RELATIVE_DIR+"gamesFixes.js",v.GAMEOVER_RELATIVE_DIR+"gameover.css",v.SDK_RELATIVE_DIR+"cordova.js",v.SDK_RELATIVE_DIR+"cordova_plugins.js",v.SDK_RELATIVE_DIR+"dixie.js",v.SDK_RELATIVE_DIR+"stargate.js",v.SDK_RELATIVE_DIR+"gfsdk.min.js"])}).then(function(e){return I.d("injectScripts result",e),c({type:"download"}),n.id})}if(this.isDownloading())return Promise.reject(["Downloading...try later",e.currentFileTransfer]);var o=e.dirExists(v.GAMES_DIR+n.id);t=t?t:{};var a=t.onProgress?t.onProgress:function(){},s=t.onStart?t.onStart:function(){},c=t.onEnd?t.onEnd:function(){},l=n.id;return o.then(function(e){return I.d("Exists",e),e?Promise.reject({12:"AlreadyExists",gameID:n.id}):i()})},o.prototype.play=function(n){I.d("Play",n);var t=v.GAMES_DIR+n;return e.readDir(t).then(function(e){return e.filter(function(e){var n=new RegExp(/index\.html$/i);return n.test(e.path)})}).then(function(e){I.d(e);var n=e[0].internalURL+"?hybrid=1";"ios"==window.device.platform.toLowerCase()?(I.d("Play ios",n),window.location.href=n):(I.d("Play android",n),window.navigator.app.loadUrl(encodeURI(n)))})},o.prototype.remove=function(n){return e.removeDir(v.GAMES_DIR+n)},o.prototype.isDownloading=function(){return null!==e.currentFileTransfer||void 0===e.currentFileTransfer},o.prototype.abortDownload=function(){return this.isDownloading()?(e.currentFileTransfer.abort(),e.currentFileTransfer=null,!0):(I.w("There's not a download operation to abort"),!1)},o.prototype.list=function(){return e.readDir(v.GAMES_DIR).then(function(e){var n=Array.isArray(e)?e:[e];return n.map(function(e){return e.path})}).then(function(n){var t=n.map(function(n){return e.readFileAsJSON(n+"meta.json")});return Promise.all(t).then(function(e){return e})})},o.prototype.buildGameOver=function(n){var t=v.GAMES_DIR+n.content_id+"/meta.json";return n.hasOwnProperty("content_id")?(I.d("Read meta.json:",t),I.d("GAMEOVER_TEMPLATE path",v.GAMEOVER_DIR+"gameover.html"),Promise.all([e.readFileAsJSON(t),e.readFile(v.GAMEOVER_DIR+"gameover.html")]).then(function(e){var t=e[1],r=e[0];return t.replace("{{score}}",n.score).replace("{{url_share}}",r.url_share).replace("{{url_cover}}",r.url_cover).replace("{{startpage_url}}",v.WWW_DIR+"startpage.html")})):Promise.reject("Missing content_id key!")};var A={};i.game={},A.initialize=a,i.game._protected=A,i.game._public=new o}(a.file,a.Utils.Logger,a.Utils.composeApiString,a.Utils.Iterator,a),function(e){function n(e,t){this.level=n.levels[e.toUpperCase()],this.tag=t}function t(e){var n=0;return{next:function(t){return t&&(n=0),n<e.length?{value:e[n++],done:!1}:{done:!0}}}}function r(e,n){e+="?";var t="";for(var r in n)t+=encodeURIComponent(r)+"="+encodeURIComponent(n[r])+"&";return t.length>0&&(t=t.substring(0,t.length-1)),e+t}n.levels={ALL:5,ERROR:4,WARN:3,INFO:2,DEBUG:1,OFF:0},n.prototype.e=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.ERROR&&window.console.error.apply(console,e)},n.prototype.i=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.WARN&&window.console.info.apply(console,e)},n.prototype.w=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.INFO&&window.console.warn.apply(console,e)},n.prototype.d=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this.tag),0!==this.level&&this.level>=n.levels.DEBUG&&window.console.log.apply(console,e)},n.prototype.setLevel=function(e){this.level=n.levels[e]};var i={Iterator:t,Logger:n,composeApiString:r};e?e.Utils=i:window.Utils=i}(a),function(e,n){function t(e){var n=e.map(function(e){return{fullPath:e.fullPath,path:e.toURL(),internalURL:e.toInternalURL(),isFile:e.isFile,isDirectory:e.isDirectory}});return 1==n.length?n[0]:n}var r,i={};return i.LOG=r=new n("ALL","[File - module]"),i.ERROR_MAP={1:"NOT_FOUND_ERR",2:"SECURITY_ERR",3:"ABORT_ERR",4:"NOT_READABLE_ERR",5:"ENCODING_ERR",6:"NO_MODIFICATION_ALLOWED_ERR",7:"INVALID_STATE_ERR",8:"SYNTAX_ERR",9:"INVALID_MODIFICATION_ERR",10:"QUOTA_EXCEEDED_ERR",11:"TYPE_MISMATCH_ERR",12:"PATH_EXISTS_ERR"},i.currentFileTransfer=null,i.resolveFS=function(e){return new Promise(function(n,t){window.resolveLocalFileSystemURL(e,n,t)})},i.appendToFile=function(e,n,r){return r=void 0===arguments[2]?!1:arguments[2],i.resolveFS(e).then(function(e){return new Promise(function(i,o){e.createWriter(function(a){r||a.seek(a.length);var s=new Blob([n],{type:"text/plain"});a.write(s),a.onerror=o,a.onabort=o,a.onwriteend=function(){i(t([e]))}},o)})})},i.readFileAsHTML=function(e){return i.readFile(e).then(function(e){return(new window.DOMParser).parseFromString(e,"text/html")})},i.readFileAsJSON=function(e){return i.readFile(e).then(function(e){try{return Promise.resolve(window.JSON.parse(e))}catch(n){return Promise.reject(n)}})},i.removeFile=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.remove(function(e){n(null===e||"OK"===e)},t)})})},i.removeDir=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.removeRecursively(function(e){n(null===e||"OK"===e)},t)})})},i._promiseZip=function(e,n,t){return r.d("PROMISEZIP:",arguments),new Promise(function(r,i){window.zip.unzip(e,n,function(e){0===e?r(!0):i(e)},t)})},i.download=function(e,n,r,o){var a=new window.FileTransfer;return a.onprogress=o,i.currentFileTransfer=a,new Promise(function(o,s){a.download(window.encodeURI(e),n+r,function(e){o(t([e])),i.currentFileTransfer=null},function(e){s(e),i.currentFileTransfer=null},!0)})},i.createDir=function(e,n){return i.resolveFS(e).then(function(e){return new Promise(function(r,i){e.getDirectory(n,{create:!0},function(e){r(t([e]))},i)})})},i.fileExists=function(e){return new Promise(function(n){window.resolveLocalFileSystemURL(e,function(e){n(e.isFile)},function(e){n(1!==e.code)})})},i.dirExists=function(e){return new Promise(function(n){window.resolveLocalFileSystemURL(e,function(e){n(e.isDirectory)},function(e){n(1!=e.code)})})},i.requestFileSystem=function(e,n){return new Promise(function(t,r){window.requestFileSystem(e,n,t,r)})},i.readDir=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,r){var i=e.createReader();i.readEntries(function(e){n(t(e))},r)})})},i.readFile=function(e){return i.resolveFS(e).then(function(e){return new Promise(function(n,t){e.file(function(e){var r=new FileReader;r.onerror=t,r.onabort=t,r.onloadend=function(){var e=this.result;n(e)},r.readAsText(e)})})})},i.createFile=function(e,n){return i.resolveFS(e).then(function(e){return new Promise(function(r,i){e.getFile(n,{create:!0},function(e){r(t([e]))},i)})})},i.write=function(e,n){return i.appendToFile(e,n,!0)},i.moveDir=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return r.d("moveDir:",o,t),Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(e){return r.d("moveDir: resolved entries",e),new Promise(function(n,r){e[0].moveTo(e[1],t,n,r)})})},i.copyFile=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(e){return r.d("copyFileTo",e),new Promise(function(n,r){e[0].copyTo(e[1],t,n,r)})})},i.copyDir=function(e,n){var t=n.substring(n.lastIndexOf("/")+1),o=n.replace(t,"");return Promise.all([i.resolveFS(e),i.resolveFS(o)]).then(function(i){return r.d("copyDir",e,"in",n),new Promise(function(e,n){i[0].copyTo(i[1],t,e,n)})})},e.file=i,i}(a,a.Utils.Logger),function(e,n,t,r,i){"use strict";function o(){}function a(n){function r(){var n=e.createDir(v.BASE_DIR,"games"),t=e.createDir(v.BASE_DIR,"scripts");return Promise.all([n,t]).then(function(n){return I.d("GamesDir and ScriptsDir created",n),I.d("Getting SDK from:",y),Promise.all([e.download(y,n[1].path,"gfsdk.min.js"),e.download(_,n[1].path,"dixie.js"),e.copyDir(v.WWW_DIR+"gameover_template",v.BASE_DIR+"gameover_template"),e.copyDir(v.WWW_DIR+"plugins",v.SDK_DIR+"plugins"),e.copyFile(v.CORDOVAJS,v.SDK_DIR+"cordova.js"),e.copyFile(v.CORDOVA_PLUGINS_JS,v.SDK_DIR+"cordova_plugins.js"),e.copyFile(v.STARGATEJS,v.SDK_DIR+"stargate.js"),e.copyFile(v.WWW_DIR+"js/gamesFixes.js",v.SDK_DIR+"gamesFixes.js")])})}if(I.d("Initialized called with:",n),!e)return Promise.reject("Missing file module!");if(n&&n.bundleGames){for(var o=0;o<n.bundleGames.length;o++)D.content_id=n.bundleGames[o],R.push(t(S,D));I.d("addressesForMeta composed but not called:",R)}try{f=window.cordova.file.applicationStorageDirectory,p=window.cordova.file.cacheDirectory,m=window.cordova.file.tempDirectory,g=window.cordova.file.applicationDirectory+"www/",h=window.cordova.file.applicationDirectory+"www/js/stargate.js",w=window.cordova.file.dataDirectory}catch(a){return I.e(a),Promise.reject(a)}I.i("cordova JS dir to include",v.CORDOVAJS),"ios"==window.device.platform.toLowerCase()&&(f+="Documents/"),"android"==window.device.platform.toLowerCase()&&(m=p),v.SDK_DIR=f+"scripts/",v.SDK_RELATIVE_DIR="../../scripts/",v.GAMEOVER_RELATIVE_DIR="../../gameover_template/",v.GAMES_DIR=f+"games/",v.BASE_DIR=f,v.CACHE_DIR=p,v.TEMP_DIR=m,v.CORDOVAJS=g+"cordova.js",v.CORDOVA_PLUGINS_JS=g+"cordova_plugins.js",v.STARGATEJS=g+"js/stargate.js",v.DATA_DIR=w,v.GAMEOVER_DIR=v.BASE_DIR+"gameover_template/",v.WWW_DIR=g,i.game._public.GAMES_DIR=v.GAMES_DIR;var s=e.dirExists(v.GAMES_DIR),c=e.fileExists(v.SDK_DIR+"gfsdk.min.js");return Promise.all([s,c]).then(function(e){return e[0]||e[1]?Promise.resolve(!0):r()})}function s(n){return I.d("_getIndexHtmlById",v.GAMES_DIR+n),e.readDir(v.GAMES_DIR+n).then(function(e){return I.d("_getIndexHtmlById readDir",e),e.filter(function(e){var n=new RegExp(/index\.html$/i);return n.test(e.path)})})}function c(e){I.d("_removeRemoteSDK");for(var n,t=e.querySelectorAll("script"),r=0;r<t.length;r++)if(-1!==t[r].src.indexOf("gfsdk")){n=t[r],I.d("_removeRemoteSDK",n),n.parentNode.removeChild(n);break}return e}function l(e,n){e=c(e);var t,r=Array.isArray(n)===!1?[n]:n;I.d("injectScripts",r);var i=document.createElement("meta");i.httpEquiv="Content-Security-Policy",i.content="default-src * data: content: cdvfile: file: http: https: gap: https://ssl.gstatic.com 'unsafe-inline' 'unsafe-eval';style-src * cdvfile: http: https: 'unsafe-inline';",e.head.appendChild(i);for(var o=0;o<r.length;o++)if(r[o].endsWith(".css")){I.d("css inject:",r[o]);var a=e.createElement("link");a.rel="stylesheet",a.href=r[o],e.head.appendChild(a)}else t=document.createElement("script"),t.src=r[o],e.head.appendChild(t);return I.d("Cleaned dom:",e),e}function u(n,t){var r;return s(n).then(function(n){return r=n[0].path,e.readFileAsHTML(n[0].path)}).then(function(e){return I.d("_injectScripts"),I.d(e),l(e,t)}).then(function(e){I.d("Serialize dom");var n=(new XMLSerializer).serializeToString(e),t='<html xmlns="http://www.w3.org/1999/xhtml"';return n=n.replace(t,"<html")}).then(function(n){return I.d("Write dom:",r,n),e.write(r,n)})}function d(e){var n=new RegExp(/index\.html$/i);return n.test(e)}var f,p,m,g,w,h,v={},y="http://s2.motime.com/js/wl/webstore_html5game/gfsdk/dist/gfsdk.js?timestamp="+Date.now(),_="http://s2.motime.com/tbr/dixie.js?country=it-igames&timestamp="+Date.now(),S="http://resources2.buongiorno.com/lapis/apps/contents.getList",R=[],D={content_id:"",formats:"html5applications",sort:"-born_date",category:"b940b384ff0565b06dde433e05dc3c93",publisher:"",size:6,offset:0,label:"",label_slug:"",access_type:"",real_customer_id:"xx_gameasy",lang:"en",use_cs_id:"",white_label:"xx_gameasy",main_domain:"http://www2.gameasy.com/ww/&country=it",fw:"gameasy",vh:"ww.gameasy.com",check_compatibility_header:0},I=new n("ALL","[Game - module]");o.prototype.download=function(n,t){function r(e){return function(n){var t=Math.round(n.loaded/n.total*100);a({percentage:t,type:e})}}function i(){return s({type:"download"}),I.d("Download:",n.id,n.response_api_dld.binary_url),e.download(n.response_api_dld.binary_url,v.TEMP_DIR,l+".zip",r("download")).then(function(t){return s({type:"unzip"}),I.d("unzip:",n.id,v.TEMP_DIR+l),e._promiseZip(t.path,v.TEMP_DIR+l,r("unzip"))}).then(function(t){I.d("Unzip ended",t),c({type:"unzip"});var r=n.response_api_dld.url_download,i=r.substring(r.lastIndexOf("game"),r.length).split("/"),o="";return I.d("Get the right index folder of the game",i),i.length>2&&d(i[i.length-1])?(o=v.TEMP_DIR+[l,i[i.length-2]].join("/"),I.d("More than one level folders before index.html",i,o)):(o=v.TEMP_DIR+l,I.d("One level folder before index.html",i,o)),I.d("Copy game folder in games/",o,v.GAMES_DIR+l),e.moveDir(o,v.GAMES_DIR+l)}).then(function(n){return I.d("Remove zip from:",v.TEMP_DIR+l+".zip","last operation result",n),e.removeFile(v.TEMP_DIR+l+".zip")}).then(function(){return I.d("Save meta.json for:",n.id),e.createFile(v.GAMES_DIR+l,"meta.json").then(function(t){return e.write(t.path,JSON.stringify(n))})}).then(function(e){return I.d("result last operation:save meta.json",e),I.d("InjectScripts in game:",n.id,g),u(n.id,[v.SDK_RELATIVE_DIR+"gamesFixes.js",v.GAMEOVER_RELATIVE_DIR+"gameover.css",v.SDK_RELATIVE_DIR+"cordova.js",v.SDK_RELATIVE_DIR+"cordova_plugins.js",v.SDK_RELATIVE_DIR+"dixie.js",v.SDK_RELATIVE_DIR+"stargate.js",v.SDK_RELATIVE_DIR+"gfsdk.min.js"])}).then(function(e){return I.d("injectScripts result",e),c({type:"download"}),n.id})}if(this.isDownloading())return Promise.reject(["Downloading...try later",e.currentFileTransfer]);var o=e.dirExists(v.GAMES_DIR+n.id);t=t?t:{};var a=t.onProgress?t.onProgress:function(){},s=t.onStart?t.onStart:function(){},c=t.onEnd?t.onEnd:function(){},l=n.id;return o.then(function(e){return I.d("Exists",e),e?Promise.reject({12:"AlreadyExists",gameID:n.id}):i()})},o.prototype.play=function(n){I.d("Play",n);var t=v.GAMES_DIR+n;return e.readDir(t).then(function(e){return e.filter(function(e){var n=new RegExp(/index\.html$/i);return n.test(e.path)})}).then(function(e){I.d(e);var n=e[0].internalURL+"?hybrid=1";"ios"==window.device.platform.toLowerCase()?(I.d("Play ios",n),window.location.href=n):(I.d("Play android",n),window.navigator.app.loadUrl(encodeURI(n)))})},o.prototype.remove=function(n){return e.removeDir(v.GAMES_DIR+n)},o.prototype.isDownloading=function(){return null!==e.currentFileTransfer||void 0===e.currentFileTransfer},o.prototype.abortDownload=function(){return this.isDownloading()?(e.currentFileTransfer.abort(),e.currentFileTransfer=null,!0):(I.w("There's not a download operation to abort"),!1)},o.prototype.list=function(){return e.readDir(v.GAMES_DIR).then(function(e){var n=Array.isArray(e)?e:[e];return n.map(function(e){return e.path})}).then(function(n){var t=n.map(function(n){return e.readFileAsJSON(n+"meta.json")});return Promise.all(t).then(function(e){return e})})},o.prototype.buildGameOver=function(n){var t=v.GAMES_DIR+n.content_id+"/meta.json";return n.hasOwnProperty("content_id")?(I.d("Read meta.json:",t),I.d("GAMEOVER_TEMPLATE path",v.GAMEOVER_DIR+"gameover.html"),Promise.all([e.readFileAsJSON(t),e.readFile(v.GAMEOVER_DIR+"gameover.html")]).then(function(e){var t=e[1],r=e[0];return t.replace("{{score}}",n.score).replace("{{url_share}}",r.url_share).replace("{{url_cover}}",r.url_cover).replace("{{startpage_url}}",v.WWW_DIR+"startpage.html")})):Promise.reject("Missing content_id key!")};var A={};i.game={},A.initialize=a,i.game._protected=A,i.game._public=new o}(a.file,a.Utils.Logger,a.Utils.composeApiString,a.Utils.Iterator,a);var s=function(){var e={},n=!1;e.init=function(){if(k.hasOwnProperty("webappsfixes")&&"object"==typeof k.webappsfixes){n=!0;for(var e in k.webappsfixes)if(k.webappsfixes.hasOwnProperty(e))if(t.hasOwnProperty(e)&&"function"==typeof t[e]){f("[webappsFixes] applying fix: "+e);var r=t[e](k.webappsfixes[e]);r&&p("[webappsFixes] fix '"+e+"' failed: "+r)}else p("[webappsFixes] fix implementation not found for: "+e)}return n};var t={};return t.gamifiveSearchBox=function(e){if(!window.cordova||!window.cordova.plugins||!window.cordova.plugins.Keyboard)return"missing ionic-plugin-keyboard";if(e.platforms){if(h()&&!e.platforms.ios)return void f("[webappsFixes] [gamifiveSearchBox] fix disabled on iOS");if(w()&&!e.platforms.android)return void f("[webappsFixes] [gamifiveSearchBox] fix disabled on Android")}return window.addEventListener("native.keyboardshow",function(){setTimeout(function(){0===document.querySelectorAll("input:focus").length&&(f("[webappsFixes] [gamifiveSearchBox] keyboard show on null input: hiding"),cordova.plugins.Keyboard.close())},1)},!1),f("[webappsFixes] [gamifiveSearchBox] listening on event native.keyboardshow"),""},e}();window.pubKey="",window.forge="";var c;o.initializeOffline=function(e){return c?c:("object"!=typeof e&&(e={}),e.hasOwnProperty("hideSplashScreen")||(e.hideSplashScreen=!0),S=!0,c=new Promise(function(r){document.addEventListener("deviceready",function(){F(),v(),n(),Promise.all([cordova.getAppVersion.getVersionNumber(),t()]).then(function(n){I=n[0],"object"!=typeof n[1]&&(n[1]=JSON.parse(n[1])),u=n[1].start_url,k=n[1].stargateConf,e.hideSplashScreen&&(navigator.splashscreen.hide(),j(!1)),R=!0,f("Stargate.initializeOffline() done"),r(!0)})["catch"](function(e){p("initializeOffline() error: "+e)})})}))},o.conf={},o.conf.getWebappStartUrl=function(){return k.webapp_start_url},o.conf.getWebappOrigin=function(){var e=/http:\/\/[\w]{3,4}\..*\.[\w]{2,}/;return"undefined"==typeof k.webapp_start_url?(f("Stargate is initialized? Please call this method after it"),""):e.exec(k.webapp_start_url)[0]},o.initialize=function(e,n,t,r){if("function"==typeof n&&"undefined"==typeof t&&"undefined"==typeof r&&(r=n),"undefined"==typeof r&&(f("Callback success not setted. \n You can use 'then'"),r=function(){}),"function"!=typeof r)return m("Stargate.initialize() callback is not a function!"),Promise.reject(new Error("Stargate.initialize() callback is not a function!"));if(_=U(),S)return m("Stargate.initialize() already called, executing callback."),r&&r(_),Promise.resolve(_);if(S=!0,"object"!=typeof e&&(e={}),e.hybrid_conf&&(A="object"==typeof e.hybrid_conf?e.hybrid_conf:JSON.parse(decodeURIComponent(e.hybrid_conf))),e.modules?e.modules.constructor!==Array?p("initialize() configurations.modules is not an array"):E=e.modules:E=["mfp","iapbase","appsflyer","game"],e.modules_conf&&("object"!=typeof e.modules_conf?p("initialize() configurations.modules_conf is not an object"):b=e.modules_conf),e.country&&("mfp"in A?A.mfp.country=e.country:A.mfp={country:e.country}),!_)return f("version "+i+" running outside hybrid; loaded from server version: v"+d),r&&r(_),Promise.resolve(_);f("initialize() starting up, configuration: ",A),D=r;var o=new Promise(function(e,n){document.addEventListener("deviceready",function(){L(e,n)},!1)});return o},o.isInitialized=function(){return S},o.isOpen=function(){return R},o.isHybrid=function(){return U()},o.openUrl=function(e){return S?void window.open(e,"_system"):p("Stargate not initialized, call Stargate.initialize first!")},o.googleLogin=function(e,n){return S?(p("unimplemented"),void n("unimplemented")):n("Stargate not initialized, call Stargate.initialize first!")};var l={type:"unknown",networkState:"unknown"};window.addEventListener("online",e,!1),window.addEventListener("offline",e,!1),o.checkConnection=function(){var e=arguments.length<=0||void 0===arguments[0]?function(){}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1];return S?"function"!=typeof navigator.connection.getInfo?(n("Missing cordova plugin"),console.warn("Cordova Network Information module missing"),!1):(e(l),l):(n("Stargate not initialized, call Stargate.initialize first!"),!1)},o.getDeviceID=function(e,n){if(!S)return n("Stargate not initialized, call Stargate.initialize first!");var t=g.uuid;e({deviceID:t})},o.setStatusbarVisibility=function(e,n,t){return S?"undefined"==typeof window.StatusBar?(p("[StatusBar] missing cordova plugin"),t("missing cordova plugin")):e?(window.StatusBar.show(),n("statusbar shown")):(window.StatusBar.hide(),n("statusbar hided")):t("Stargate not initialized, call Stargate.initialize first!")},o.getVersion=function(){
return i},o.ad=new r;var u,d="2",f=console.log.bind(window.console,"[Stargate] "),p=console.error.bind(window.console,"[Stargate] "),m=console.warn.bind(window.console,"[Stargate] "),g={available:!1,cordova:"",manufacturer:"",model:"",platform:"",uuid:"",version:""},w=function(){return"Android"==g.platform},h=function(){return"iOS"==g.platform},v=function(){if("undefined"==typeof window.device)return p("Missing cordova device plugin");for(var e in g)window.device.hasOwnProperty(e)&&(g[e]=window.device[e]);return!0},y=function(e){f("launchUrl: "+e),document.location.href=e},_=!1,S=!1,R=!1,D=null,I="",A={},E=[],b={},P=function(){if("undefined"==typeof window.StatusBar)return p("[StatusBar] missing cordova plugin");if("undefined"!=typeof k.statusbar&&"undefined"!=typeof k.statusbar.hideOnUrlPattern&&k.statusbar.hideOnUrlPattern.constructor===Array){for(var e=document.location.href,n=!1,t=0;t<k.statusbar.hideOnUrlPattern.length;t++){var r=new RegExp(k.statusbar.hideOnUrlPattern[t]);if(r.test(e)){n=!0;break}}n?window.StatusBar.hide():window.StatusBar.show()}},F=function(){window.Cookies.set("hybrid","1"),window.Cookies.set("stargateVersion",d),window.localStorage.getItem("hybrid")||window.localStorage.setItem("hybrid",1),window.localStorage.getItem("stargateVersion")||window.localStorage.setItem("stargateVersion",d)},O=function(){navigator.splashscreen.hide(),j(!1),"undefined"!=typeof SpinnerDialog&&SpinnerDialog.hide()},T=function(e){if(document.title=k.title,h()&&"undefined"!=typeof window.cordova&&cordova.require){var n=cordova.require("cordova/exec");n.setJsToNativeBridgeMode(n.jsToNativeModes.IFRAME_NAV)}if(P(),G("mfp")&&z("mfp")){var t=C("mfp"),r=["motime_apikey","namespace","label"];r.forEach(function(e){!t.hasOwnProperty(e)&&k.hasOwnProperty(e)&&(t[e]=k[e])}),N.check(t)}G("deltadna")&&window.deltadna.startSDK(k.deltadna.environmentKey,k.deltadna.collectApi,k.deltadna.engageApi,J,q,k.deltadna.settings),z("iapbase")?K.initialize(C("iapbase")):z("iap")&&K.initialize(C("iap"))&&K.doRefresh(),G("appsflyer")&&z("appsflyer")&&Y.init(C("appsflyer")),s.init();var i=[];z("game")&&G("game")&&a.game&&i.push(a.game._protected.initialize(C("game"))),Promise.all(i).then(function(){x(e)})["catch"](function(n){p("onPluginReady() error: ",n),x(e)})},x=function(e){O(),R=!0,f("version "+i+" ready;  running in package version: "+I),D(!0),f("Stargate.initialize() done"),e(!0)},L=function(e,r){F(),v(),n(),Promise.all([cordova.getAppVersion.getVersionNumber(),t()]).then(function(n){I=n[0],"object"!=typeof n[1]&&(n[1]=JSON.parse(n[1])),u=n[1].start_url,k=n[1].stargateConf,T(e,r)})["catch"](function(e){p("onDeviceReady() error: "+e),r("onDeviceReady() error: "+e)})},U=function(){var e=window.URI(document.location.href);return e.hasQuery("hybrid")?!0:window.Cookies.get("hybrid")?!0:window.localStorage.getItem("hybrid")?!0:!1},M=!1,j=function(e){e?(M=!0,B()):(M=!1,W())},k={features:{}},C=function(e){if(!e)return p("getModuleConf() invalid module requested");if(e in b)return b[e];var n={iapbase:"IAP",iap:"IAP"},t=e;return n[e]&&(t=n[e]),t in A?A[t]:(f("getModuleConf(): no configuration for module: "+e+" ("+n+")"),{})},G=function(e){return"undefined"!=typeof k.features[e]&&k.features[e]},z=function(e){return E&&E.constructor===Array?E.indexOf(e)>-1:!1},N=function(){var e={};return e.check=function(n){return n.country?void e.get(n.country):p("[MFP] Country not defined!")},e.getContents=function(e,n,t,r){var i={};i.api_country=t,i.country=e,i.fpnamespace=n,r&&(i.extData=r);var o=JSON.stringify(i);return o},e.getPonyValue=function(e){try{return e.split("=")[1]}catch(n){p(n)}return""},e.setSession=function(n){var t=u;window.localStorage.getItem("appUrl")&&(t=window.localStorage.getItem("appUrl"));var r=new URI(u),i=r.hostname(),o=URITemplate(k.api.mfpSetUriTemplate).expand({protocol:r.protocol(),hostname:i,url:t,domain:i,_PONY:e.getPonyValue(n)});f("[MobileFingerPrint] going to url: ",o),y(o)},e.get=function(n){var t="",r=URITemplate(k.api.mfpGetUriTemplate).expand({apikey:k.motime_apikey,contents_inapp:e.getContents(n,k.namespace,k.label),country:n,expire:t});window.aja().url(r).type("jsonp").on("success",function(n){f("[MobileFingerPrint] get() response: ",n);var t="";if(n.content.inappInfo){var r=JSON.parse(n.content.inappInfo);r.extData&&(r.extData.ponyUrl&&(t=r.extData.ponyUrl),r.extData.return_url&&window.localStorage.setItem("appUrl",r.extData.return_url),r.extData.session_mfp&&X.track({page:"hybrid_initialize",action:"MFP_get",session_mfp:r.extData.session_mfp})),e.setSession(t)}else f("[MobileFingerPrint] get(): Empty session")}).on("error",function(e){p("[MobileFingerPrint] get() error: ",e)}).go()},{check:e.check}}(),V=function(){"use strict";function e(e,n){var t=(65535&e)+(65535&n),r=(e>>16)+(n>>16)+(t>>16);return r<<16|65535&t}function n(e,n){return e<<n|e>>>32-n}function t(t,r,i,o,a,s){return e(n(e(e(r,t),e(o,s)),a),i)}function r(e,n,r,i,o,a,s){return t(n&r|~n&i,e,n,o,a,s)}function i(e,n,r,i,o,a,s){return t(n&i|r&~i,e,n,o,a,s)}function o(e,n,r,i,o,a,s){return t(n^r^i,e,n,o,a,s)}function a(e,n,r,i,o,a,s){return t(r^(n|~i),e,n,o,a,s)}function s(n,t){n[t>>5]|=128<<t%32,n[(t+64>>>9<<4)+14]=t;var s,c,l,u,d,f=1732584193,p=-271733879,m=-1732584194,g=271733878;for(s=0;s<n.length;s+=16)c=f,l=p,u=m,d=g,f=r(f,p,m,g,n[s],7,-680876936),g=r(g,f,p,m,n[s+1],12,-389564586),m=r(m,g,f,p,n[s+2],17,606105819),p=r(p,m,g,f,n[s+3],22,-1044525330),f=r(f,p,m,g,n[s+4],7,-176418897),g=r(g,f,p,m,n[s+5],12,1200080426),m=r(m,g,f,p,n[s+6],17,-1473231341),p=r(p,m,g,f,n[s+7],22,-45705983),f=r(f,p,m,g,n[s+8],7,1770035416),g=r(g,f,p,m,n[s+9],12,-1958414417),m=r(m,g,f,p,n[s+10],17,-42063),p=r(p,m,g,f,n[s+11],22,-1990404162),f=r(f,p,m,g,n[s+12],7,1804603682),g=r(g,f,p,m,n[s+13],12,-40341101),m=r(m,g,f,p,n[s+14],17,-1502002290),p=r(p,m,g,f,n[s+15],22,1236535329),f=i(f,p,m,g,n[s+1],5,-165796510),g=i(g,f,p,m,n[s+6],9,-1069501632),m=i(m,g,f,p,n[s+11],14,643717713),p=i(p,m,g,f,n[s],20,-373897302),f=i(f,p,m,g,n[s+5],5,-701558691),g=i(g,f,p,m,n[s+10],9,38016083),m=i(m,g,f,p,n[s+15],14,-660478335),p=i(p,m,g,f,n[s+4],20,-405537848),f=i(f,p,m,g,n[s+9],5,568446438),g=i(g,f,p,m,n[s+14],9,-1019803690),m=i(m,g,f,p,n[s+3],14,-187363961),p=i(p,m,g,f,n[s+8],20,1163531501),f=i(f,p,m,g,n[s+13],5,-1444681467),g=i(g,f,p,m,n[s+2],9,-51403784),m=i(m,g,f,p,n[s+7],14,1735328473),p=i(p,m,g,f,n[s+12],20,-1926607734),f=o(f,p,m,g,n[s+5],4,-378558),g=o(g,f,p,m,n[s+8],11,-2022574463),m=o(m,g,f,p,n[s+11],16,1839030562),p=o(p,m,g,f,n[s+14],23,-35309556),f=o(f,p,m,g,n[s+1],4,-1530992060),g=o(g,f,p,m,n[s+4],11,1272893353),m=o(m,g,f,p,n[s+7],16,-155497632),p=o(p,m,g,f,n[s+10],23,-1094730640),f=o(f,p,m,g,n[s+13],4,681279174),g=o(g,f,p,m,n[s],11,-358537222),m=o(m,g,f,p,n[s+3],16,-722521979),p=o(p,m,g,f,n[s+6],23,76029189),f=o(f,p,m,g,n[s+9],4,-640364487),g=o(g,f,p,m,n[s+12],11,-421815835),m=o(m,g,f,p,n[s+15],16,530742520),p=o(p,m,g,f,n[s+2],23,-995338651),f=a(f,p,m,g,n[s],6,-198630844),g=a(g,f,p,m,n[s+7],10,1126891415),m=a(m,g,f,p,n[s+14],15,-1416354905),p=a(p,m,g,f,n[s+5],21,-57434055),f=a(f,p,m,g,n[s+12],6,1700485571),g=a(g,f,p,m,n[s+3],10,-1894986606),m=a(m,g,f,p,n[s+10],15,-1051523),p=a(p,m,g,f,n[s+1],21,-2054922799),f=a(f,p,m,g,n[s+8],6,1873313359),g=a(g,f,p,m,n[s+15],10,-30611744),m=a(m,g,f,p,n[s+6],15,-1560198380),p=a(p,m,g,f,n[s+13],21,1309151649),f=a(f,p,m,g,n[s+4],6,-145523070),g=a(g,f,p,m,n[s+11],10,-1120210379),m=a(m,g,f,p,n[s+2],15,718787259),p=a(p,m,g,f,n[s+9],21,-343485551),f=e(f,c),p=e(p,l),m=e(m,u),g=e(g,d);return[f,p,m,g]}function c(e){var n,t="";for(n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function l(e){var n,t=[];for(t[(e.length>>2)-1]=void 0,n=0;n<t.length;n+=1)t[n]=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}function u(e){return c(s(l(e),8*e.length))}function d(e,n){var t,r,i=l(e),o=[],a=[];for(o[15]=a[15]=void 0,i.length>16&&(i=s(i,8*e.length)),t=0;16>t;t+=1)o[t]=909522486^i[t],a[t]=1549556828^i[t];return r=s(o.concat(l(n)),512+8*n.length),c(s(a.concat(r),640))}function f(e){var n,t,r="0123456789abcdef",i="";for(t=0;t<e.length;t+=1)n=e.charCodeAt(t),i+=r.charAt(n>>>4&15)+r.charAt(15&n);return i}function p(e){return unescape(encodeURIComponent(e))}function m(e){return u(p(e))}function g(e){return f(m(e))}function w(e,n){return d(p(e),p(n))}function h(e,n){return f(w(e,n))}function v(e,n,t){return n?t?w(n,e):h(n,e):t?m(e):g(e)}return v}(),B=function(e){if("undefined"==typeof window.SpinnerDialog)return p("startLoading(): SpinnerDialog cordova plugin missing!");"object"!=typeof e&&(e={});var n=null;return e.hasOwnProperty("message")&&(n=e.message),window.SpinnerDialog.show(null,n),!0},W=function(){return"undefined"==typeof window.SpinnerDialog?p("startLoading(): SpinnerDialog cordova plugin missing!"):(window.SpinnerDialog.hide(),!0)};window.startLoading=B,window.stopLoading=W;var K={id:"",alias:"",type:"",verbosity:"",paymethod:"",subscribeMethod:"stargate",returnUrl:"",callbackSuccess:function(){f("[IAP] Undefined callbackSuccess")},callbackError:function(){f("[IAP] Undefined callbackError")},callbackListingSuccess:function(){f("[IAP] Undefined callbackListingSuccess")},callbackListingError:function(){f("[IAP] Undefined callbackListingError")},requestedListingProductId:"",refreshDone:!1,lastCreateuserUrl:"",lastCreateuserData:"",createUserAttempt:0,maxCreateUserAttempt:6,productsInfo:{},initialize:function(e){return window.store?(K.returnUrl=document.location.href,e.id?K.id=e.id:w()?K.id=e.id_android:h()&&(K.id=e.id_ios),K.id?(e.alias&&(K.alias=e.alias),e.type&&(K.type=e.type),K.verbosity="INFO",K.paymethod=w()?"gwallet":"itunes",f("IAP initialize id: "+K.id),w()&&K.getGoogleAccount(),window.store.verbosity=window.store[K.verbosity],window.store.register({id:K.id,alias:K.alias,type:window.store[K.type]}),window.store.when(K.alias).approved(function(e){K.onPurchaseApproved(e)}),window.store.when(K.alias).verified(function(e){K.onPurchaseVerified(e)}),window.store.when(K.alias).updated(function(e){K.onProductUpdate(e)}),window.store.when(K.alias).owned(function(e){K.onProductOwned(e)}),window.store.when(K.alias).cancelled(function(e){K.onCancelledProduct(e)}),window.store.when(K.alias).error(function(e){K.error(JSON.stringify(e))}),window.store.ready(function(){K.onStoreReady()}),window.store.when("order "+K.id).approved(function(e){K.onOrderApproved(e)}),window.store.when("product").updated(function(e){K.saveProductInfo(e)}),!0):(p("[IAP] Configuration error, missing product id!"),!1)):(p("[IAP] Store not available, missing cordova plugin."),!1)},saveProductInfo:function(e){return"object"!=typeof e?void p("[IAP] saveProductInfo() got invalid data"):"id"in e?(K.productsInfo[e.id]=e,void(K.requestedListingProductId===e.id&&K.callbackListingSuccess(e))):void p("[IAP] saveProductInfo() got invalid data, id undefined")},doRefresh:function(e){(!K.refreshDone||e)&&(window.store.refresh(),K.refreshDone=!0)},getPassword:function(e){return V("iap."+e+".playme").substr(0,8)},getGoogleAccount:function(){window.accountmanager.getAccounts(K.checkGoogleAccount,K.error,"com.google")},checkGoogleAccount:function(e){if(e){f("[IAP] accounts"),f(e);for(var n in e)return window.localStorage.setItem("googleAccount",e[n].email),e[n].email}},onProductUpdate:function(e){f("IAP> Product updated."),f(JSON.stringify(e)),f(e.owned?"[IAP] Subscribed!":"[IAP] Not Subscribed")},onPurchaseApproved:function(e){f("IAP> Purchase approved."),f(JSON.stringify(e)),e.finish()},onPurchaseVerified:function(e){f("subscription verified ",e)},onStoreReady:function(){f("\\o/ STORE READY \\o/")},onProductOwned:function(e){if(f("[IAP] > Product Owned."),!e.transaction.id&&h())return f("[IAP] > no transaction id"),!1;if(window.localStorage.setItem("product",e),h()&&window.localStorage.setItem("transaction_id",e.transaction.id),w()){var n=e.transaction.purchaseToken+"|"+k.id+"|"+K.id;f("[IAP] Purchase Token: "+n),window.localStorage.getItem("user_account")||K.createUser(e,n)}else window.storekit.loadReceipts(function(n){window.localStorage.getItem("user_account")||(n.appStoreReceipt?(f("[IAP] appStoreReceipt: "+n.appStoreReceipt),K.createUser(e,n.appStoreReceipt)):f("[IAP] appStoreReceipt empty, ignoring request"))})},onCancelledProduct:function(e){j(!1),K.callbackError({iap_cancelled:1,return_url:K.returnUrl}),f("[IAP] > Purchase cancelled ##################################",e)},onOrderApproved:function(e){f("[IAP] ORDER APPROVED "+K.id),e.finish()},error:function(e){j(!1),K.callbackError({iap_error:1,return_url:K.returnUrl}),p("[IAP] error: "+e)},createUser:function(e,n){f("[IAP] createUser start "),window.localStorage.setItem("user_account",w()?window.localStorage.getItem("googleAccount")?window.localStorage.getItem("googleAccount"):n+"@google.com":e.transaction.id+"@itunes.com");var t=K.subscribeMethod,r={paymethod:K.paymethod,user_account:window.localStorage.getItem("user_account"),purchase_token:n,return_url:K.returnUrl,inapp_pwd:K.getPassword(n),hybrid:1};K.lastCreateuserUrl=t,K.lastCreateuserData=r;var i=function(e){if(K.createUserAttempt<=K.maxCreateUserAttempt)p("[IAP] createUser failed "+K.createUserAttempt+" times, trying again... last error: "+JSON.stringify(e)),s();else{f("[IAP] createUser onCreateError: removing user_account"),window.localStorage.removeItem("user_account");var n={iap_error:"1",return_url:K.returnUrl};j(!1),K.callbackError(n)}},o=function(e){f("[IAP] createUser success ",e);try{e.device_id=g.uuid,window.localStorage.getItem("transaction_id")&&(e.transaction_id=window.localStorage.getItem("transaction_id")),j(!1),K.callbackSuccess(e)}catch(n){i(n)}},a=10,s=function(){setTimeout(function(){K.createUserAttempt=K.createUserAttempt+1,f("[IAP] createUser attempt: "+K.createUserAttempt+" with timeout: "+a+"sec."),window.aja().method("POST").url(K.lastCreateuserUrl).cache(!1).timeout(1e3*a).data(K.lastCreateuserData).on("success",function(e){o(e)}).on("error",function(e){i(e)}).on("4**",function(e){i(e)}).on("5**",function(e){i(e)}).on("timeout",function(){i("timeout")}).on("end",function(){f("[IAP] createUser end"),j(!1)}).go(),a+=5},10)};K.createUserAttempt=0,s()}};o.inAppPurchaseSubscription=function(e,n,t,r){return S?R?(j(!0),"undefined"!=typeof r&&(K.returnUrl=r),"undefined"!=typeof t&&(K.subscribeMethod=t),K.callbackSuccess=e,K.callbackError=n,K.doRefresh(),void window.store.order(K.id)):n("Stargate closed, wait for Stargate.initialize to complete!"):n("Stargate not initialized, call Stargate.initialize first!")},o.inAppRestore=function(e,n,t,r){return S?R?("undefined"!=typeof t&&(K.subscribeMethod=t),"undefined"!=typeof r&&(K.returnUrl=r),K.callbackSuccess=e,K.callbackError=n,void K.doRefresh(!0)):n("Stargate closed, wait for Stargate.initialize to complete!"):n("Stargate not initialized, call Stargate.initialize first!")},o.inAppProductInfo=function(e,n,t){return S?R?(e||(e=K.id),K.productsInfo[e]?void n(K.productsInfo[e]):(K.requestedListingProductId=e,K.callbackListingSuccess=n,K.callbackListingError=t,void K.doRefresh(!0))):t("Stargate closed, wait for Stargate.initialize to complete!"):t("Stargate not initialized, call Stargate.initialize first!")},o.facebookLogin=function(e,n,t){return S?void facebookConnectPlugin.login(e.split(","),function(e){f("[facebook] got userdata: ",e),facebookConnectPlugin.getAccessToken(function(e){n({accessToken:e})},function(e){t({error:e})})},function(e){p("Got FB login error:",e),t({error:e})}):t("Stargate not initialized, call Stargate.initialize first!")},o.facebookShare=function(e,n,t){if(!S)return t("Stargate not initialized, call Stargate.initialize first!");var r={method:"share",href:e};facebookConnectPlugin.showDialog(r,function(e){n({message:e})},function(e){p("Got FB share error:",e),t({error:e})})};var J=function(){deltadna.registerPushCallback(H)},q=function(e){p("[DeltaDNA] error: "+e)},H=function(e){return w()&&e.payload&&e.payload.url&&!e.foreground?y(e.payload.url):h()&&e.url?y(e.url):void 0},Y=function(){var e,n={},t={};return n.init=function(){if(!window.plugins||!window.plugins.appsFlyer)return p("[appsflyer] missing cordova plugin");if("undefined"==typeof k.appstore_appid)return p("[appsflyer] missing manifest configuration: appstore_appid");if("undefined"==typeof k.appsflyer_devkey)return p("[appsflyer] missing manifest configuration: appsflyer_devkey");var n=[k.appsflyer_devkey];h()&&n.push(k.appstore_appid),document.addEventListener("onInstallConversionDataLoaded",function(n){if(t=n.detail,"function"!=typeof e)return f("[appsflyer] callback not set!");try{e(t),f("[appsflyer] parameters sent to webapp callback: "+JSON.stringify(t))}catch(r){p("[appsflyer] callback error: "+r,r)}},!1),window.plugins.appsFlyer.initSdk(n)},n.setCallback=function(n){e=n},n}();o.setConversionDataCallback=function(e){Y.setCallback(e)};var X=function(){var e,n={};return n.track=function(n){if("function"!=typeof e)return f("[analytics] callback not set!");try{e(n)}catch(t){p("[analytics] callback error: "+t,t)}},n.setCallback=function(n){e=n},n}();o.setAnalyticsCallback=function(e){X.setCallback(e)};return o.game=a.game._public,o.file=a.file,o});